<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>ESCALA LOUVOR 2026</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2563eb">
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root {
            --bg: #f4f6fb; --card: #ffffff; --text: #1f2937; --primary: #2563eb;
            --danger: #dc2626; --success: #16a34a; --border: #cbd5e1; --shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
            --gold: #d4af37;
        }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); padding: 16px; -webkit-tap-highlight-color: transparent; }
        .container { max-width: 1000px; margin: auto; }
        .header-app { display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 25px; padding: 10px; }
        .logo-container { width: 60px; height: 60px; border-radius: 12px; overflow: hidden; display: flex; align-items: center; justify-content: center; background: var(--gold); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        #logoImg { width: 100%; height: 100%; object-fit: cover; display: none; }
        #logoEmoji { font-size: 30px; color: white; }
        .app-name { font-size: 26px; font-weight: 800; color: var(--primary); letter-spacing: -1px; text-transform: uppercase; }
        .card { background: var(--card); border-radius: 12px; padding: 18px; margin-bottom: 20px; box-shadow: var(--shadow); border: 1px solid var(--border); }
        .row { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px; }
        input, select, button { padding: 10px; border-radius: 8px; border: 1px solid var(--border); background: var(--card); color: var(--text); font-size: 14px; }
        button { cursor: pointer; font-weight: 600; border: none; transition: 0.2s; display: flex; align-items: center; gap: 5px; }
        .primary { background: var(--primary); color: white; }
        .success { background: var(--success); color: white; }
        .danger { background: var(--danger); color: white; }
        .secondary { background: #64748b; color: white; }
        .tabs { display: flex; gap: 5px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; }
        .tab-btn { flex: 1; padding: 12px; cursor: pointer; border-radius: 8px; background: rgba(0,0,0,0.05); white-space: nowrap; }
        .tab-btn.active { background: var(--primary); color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .escala-item { padding: 10px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .escala-item b { color: var(--primary); }
        .btn-swap { background: #f1f5f9; color: #64748b; padding: 4px 8px; font-size: 12px; border: 1px solid #cbd5e1; border-radius: 4px; }
        .vocal-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 8px; padding: 10px; background: #f8fafc; border-radius: 8px; }
        .musica-tag { background: #e0e7ff; color: #4338ca; padding: 4px 10px; border-radius: 6px; font-size: 12px; margin: 3px; display: inline-block; font-weight: bold; border: 1px solid #c7d2fe; }
        .edit-mode { border: 2px solid var(--success) !important; background: #f0fff4 !important; }
        .sync-status { font-size: 11px; text-align: center; color: #64748b; margin-top: -15px; margin-bottom: 15px; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div class="header-app no-print">
        <div class="logo-container" id="logoBox">
            <span id="logoEmoji">üéµ</span>
            <img id="logoImg" src="" alt="Logo">
        </div>
        <div class="app-name">Escala Louvor</div>
    </div>
    <div id="statusSync" class="sync-status no-print">Iniciando...</div>

    <div class="tabs no-print">
        <button class="tab-btn active" onclick="openTab(event, 'abaEscala')">üìÖ Escala</button>
        <button class="tab-btn" onclick="openTab(event, 'abaHistorico')">üìú Hist√≥rico</button>
        <button class="tab-btn" onclick="openTab(event, 'abaMusicas')">üéµ Repert√≥rio</button>
        <button class="tab-btn" onclick="openTab(event, 'abaEquipe')">üë• Equipe</button>
        <button class="tab-btn" onclick="openTab(event, 'abaConfig')">‚öôÔ∏è Config</button>
    </div>

    <div id="abaEscala" class="tab-content active">
        <div class="card no-print">
            <div class="row">
                <select id="mesSelecao">
                    <option value="0">Janeiro</option><option value="1">Fevereiro</option><option value="2">Mar√ßo</option>
                    <option value="3">Abril</option><option value="4">Maio</option><option value="5">Junho</option>
                    <option value="6">Julho</option><option value="7">Agosto</option><option value="8">Setembro</option>
                    <option value="9">Outubro</option><option value="10">Novembro</option><option value="11">Dezembro</option>
                </select>
                <button class="primary" onclick="gerarEscalaCompleta()">üìã Gerar</button>
                <button class="success" onclick="salvarEscalaGerada()">üíæ Salvar</button>
                <button class="secondary" onclick="exportarParaExcel()">üìä Excel</button>
                <button class="secondary" onclick="abrirMenuCompartilhar()">üì§ Compartilhar</button>
            </div>
        </div>
        <div id="resultadoEscala"></div>
    </div>

    <div id="abaHistorico" class="tab-content">
        <div class="card no-print"><button class="danger" onclick="limparHistorico()">üóëÔ∏è Limpar Hist√≥rico</button></div>
        <div id="listaHistorico"></div>
    </div>

    <div id="abaMusicas" class="tab-content">
        <div class="card" id="formMusica">
            <h3 id="musTit">Nova M√∫sica</h3>
            <input id="musNome" placeholder="T√≠tulo da m√∫sica" style="width:100%; margin-bottom:10px;">
            <p><small>Quem pode ministrar esta m√∫sica?</small></p>
            <div id="vocaisCheck" class="vocal-grid"></div>
            <div class="row" style="margin-top:10px;">
                <button class="success" onclick="salvarMusica()">Salvar M√∫sica</button>
                <button class="secondary" onclick="resetMusForm()" id="btnMusCancel" style="display:none;">Cancelar</button>
            </div>
        </div>
        <div id="listaMusicas"></div>
    </div>

    <div id="abaEquipe" class="tab-content">
        <div class="card" id="formInt">
            <h3 id="eqpTit">Novo Integrante</h3>
            <input id="intNome" placeholder="Nome do Integrante" style="width:100%; margin-bottom:10px;">
            <div id="funcoesCheck" class="row"></div>
            <div class="row" style="margin-top:10px;">
                <button class="success" onclick="salvarInt()">Salvar Integrante</button>
                <button class="secondary" onclick="resetIntForm()" id="btnIntCancel" style="display:none;">Cancelar</button>
            </div>
        </div>
        <div id="listaIntegrantes"></div>
    </div>

    <div id="abaConfig" class="tab-content">
        <div class="card">
            <h3>üñºÔ∏è Logo</h3>
            <div class="row">
                <button class="primary" onclick="document.getElementById('inputLogo').click()">üì∑ Mudar Logo</button>
                <button class="danger" onclick="removerLogo()">üóëÔ∏è Resetar</button>
                <input type="file" id="inputLogo" style="display:none" accept="image/*" onchange="uploadLogo(event)">
            </div>
        </div>
        <div class="card">
            <h3>üíæ Dados</h3>
            <div class="row">
                <button class="secondary" onclick="fazerBackup()">üì• Backup Local (.json)</button>
            </div>
        </div>
    </div>
</div>

<script>
// --- CONFIGURA√á√ÉO ---
const firebaseConfig = {
    apiKey: "AIzaSyCoFW2dGfZTmKE4LNRL0TJBNACUneRmUJQ",
    authDomain: "escala-louvor-f5c43.firebaseapp.com",
    projectId: "escala-louvor-f5c43",
    storageBucket: "escala-louvor-f5c43.firebasestorage.app",
    messagingSenderId: "464866113516",
    appId: "1:464866113516:web:582b39b115aaeeac0772c9"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const ano = 2026;
const funcoesLista = ["Ministro", "Vocal 1", "Vocal 2", "Vocal 3", "Violonista", "Guitarrista", "Baixista", "Baterista", "Tecladista", "Mesa de Som", "M√≠dia"];

let integrantes = [];
let musicas = [];
let historico = [];
let logoSalva = localStorage.getItem("appLogo") || null;
let editIdxMus = -1; 
let editIdxInt = -1;

// --- SYNC ---
db.ref('escala_v1').on('value', (snapshot) => {
    const data = snapshot.val();
    if (data) {
        integrantes = data.integrantes || [];
        musicas = data.musicas || [];
        historico = data.historico || [];
    }
    document.getElementById('statusSync').innerText = "‚úì Sincronizado";
    renderEquipe();
    renderMusicas();
    renderHistorico();
});

function salvarNuvem() {
    db.ref('escala_v1').set({ integrantes, musicas, historico });
}

// --- L√ìGICA DE ESCALA ---
function gerarEscalaCompleta() {
    const mes = parseInt(document.getElementById("mesSelecao").value);
    const container = document.getElementById("resultadoEscala");
    if (!integrantes.length) return alert("Cadastre a equipe!");

    container.innerHTML = "";
    const diasNoMes = new Date(ano, mes + 1, 0).getDate();
    let finalHtml = "";

    for (let d = 1; d <= diasNoMes; d++) {
        const data = new Date(ano, mes, d);
        if (![0, 3].includes(data.getDay())) continue;

        let escaladosDia = [];
        let vocaisAtivos = [];
        let htmlCorpo = "";

        // 1. Ministro (Regra: Microfone 1 e Mesclar Fun√ß√£o)
        let mins = integrantes.filter(it => it.funcoes.includes("Ministro")).sort(() => Math.random() - 0.5);
        let m = mins[0];
        if (m) {
            escaladosDia.push(m.nome);
            let temVocal = m.funcoes.some(f => f.toLowerCase().includes("vocal"));
            if(temVocal) vocaisAtivos.push(m.nome); // Ocupa 1 dos 4 mics

            let label = temVocal ? "Ministro / Vocal" : "Ministro";
            htmlCorpo += `<div class="escala-item"><span>${label}: <b>${m.nome}</b></span> <button class="btn-swap no-print" onclick="trocarMembro(this, '${label}')">üîÑ</button></div>`;
        }

        // 2. Demais Fun√ß√µes
        funcoesLista.forEach(f => {
            if (f === "Ministro") return;
            
            // Regra dos 4 Microfones
            if (f.toLowerCase().includes("vocal") && vocaisAtivos.length >= 4) return;

            let cand = integrantes.filter(it => {
                // Exce√ß√£o Jossinei (Quarta sim, quarta n√£o)
                const semAno = Math.ceil((data - new Date(ano, 0, 1)) / (604800000));
                if (it.nome === "Jossinei" && data.getDay() === 3 && (semAno % 2 !== 0)) return false;
                
                return it.funcoes.includes(f) && !escaladosDia.includes(it.nome);
            }).sort(() => Math.random() - 0.5);

            let sorteado = cand[0];
            if (sorteado) {
                escaladosDia.push(sorteado.nome);
                if (f.toLowerCase().includes("vocal")) vocaisAtivos.push(sorteado.nome);
                htmlCorpo += `<div class="escala-item"><span>${f}: <b>${sorteado.nome}</b></span> <button class="btn-swap no-print" onclick="trocarMembro(this, '${f}')">üîÑ</button></div>`;
            } else {
                htmlCorpo += `<div class="escala-item"><span>${f}: <b>---</b></span> <button class="btn-swap no-print" onclick="trocarMembro(this, '${f}')">üîÑ</button></div>`;
            }
        });

        // 3. M√∫sicas
        let mPossiveis = musicas.filter(ms => ms.vocalistas && ms.vocalistas.some(v => vocaisAtivos.includes(v)));
        let mEscolhidas = mPossiveis.sort(() => Math.random() - 0.5).slice(0, 3);

        finalHtml += `
            <div class="card">
                <h3 style="text-transform:capitalize">${data.toLocaleDateString('pt-BR',{weekday:'long'})}, ${d}/${mes+1}</h3>
                <hr>${htmlCorpo}
                <div style="margin-top:10px; border-top:1px solid #eee; padding-top:10px">
                    <strong>üéµ Repert√≥rio (Mics ativos: ${vocaisAtivos.length}/4):</strong><br>
                    ${mEscolhidas.length > 0 ? mEscolhidas.map(x => `<span class="musica-tag">${x.titulo}</span>`).join("") : "---"}
                </div>
            </div>`;
    }
    container.innerHTML = finalHtml || "<p>Sem cultos.</p>";
}

// --- GEST√ÉO DE EQUIPE ---
function renderEquipe() {
    const c = document.getElementById("listaIntegrantes"); c.innerHTML = "";
    document.getElementById("funcoesCheck").innerHTML = funcoesLista.map(f => `<label style="font-size:12px"><input type="checkbox" name="f_int" value="${f}"> ${f}</label>`).join("");
    integrantes.forEach((it, i) => {
        c.innerHTML += `<div class="escala-item"><span><b>${it.nome}</b><br><small>${it.funcoes.join(", ")}</small></span>
        <div class="row"><button class="primary" onclick="editInt(${i})">‚úèÔ∏è</button><button class="danger" onclick="delInt(${i})">üóë</button></div></div>`;
    });
}

function editInt(i) {
    editIdxInt = i; 
    const it = integrantes[i];
    document.getElementById("intNome").value = it.nome;
    document.querySelectorAll('input[name="f_int"]').forEach(cb => cb.checked = it.funcoes.includes(cb.value));
    document.getElementById("btnIntCancel").style.display = "block";
    document.getElementById("formInt").classList.add("edit-mode");
    document.getElementById("eqpTit").innerText = "Editando Integrante";
}

function salvarInt() {
    const n = document.getElementById("intNome").value, f = Array.from(document.querySelectorAll('input[name="f_int"]:checked')).map(cb => cb.value);
    if(!n || !f.length) return alert("Preencha nome e fun√ß√µes!");
    if(editIdxInt > -1) integrantes[editIdxInt] = {nome: n, funcoes: f};
    else integrantes.push({nome: n, funcoes: f});
    resetIntForm(); salvarNuvem();
}

function resetIntForm() { editIdxInt = -1; document.getElementById("intNome").value = ""; document.querySelectorAll('input[name="f_int"]').forEach(cb => cb.checked = false); document.getElementById("btnIntCancel").style.display = "none"; document.getElementById("formInt").classList.remove("edit-mode"); document.getElementById("eqpTit").innerText = "Novo Integrante"; }

function delInt(i) { if(confirm("Excluir?")) { integrantes.splice(i,1); salvarNuvem(); } }

// --- GEST√ÉO DE M√öSICAS ---
function renderMusicas() {
    const c = document.getElementById("listaMusicas"); c.innerHTML = "";
    const vs = integrantes.filter(it => it.funcoes.some(f => f.includes("Vocal") || f === "Ministro"));
    document.getElementById("vocaisCheck").innerHTML = vs.map(v => `<label><input type="checkbox" name="v_mus" value="${v.nome}"> ${v.nome}</label>`).join("");
    musicas.forEach((m, i) => {
        c.innerHTML += `<div class="escala-item"><span><b>${m.titulo}</b><br><small>${m.vocalistas.join(", ")}</small></span>
        <div class="row"><button class="primary" onclick="editMusica(${i})">‚úèÔ∏è</button><button class="danger" onclick="delMusica(${i})">üóë</button></div></div>`;
    });
}

function editMusica(i) {
    editIdxMus = i; 
    const m = musicas[i];
    document.getElementById("musNome").value = m.titulo;
    document.querySelectorAll('input[name="v_mus"]').forEach(cb => cb.checked = m.vocalistas.includes(cb.value));
    document.getElementById("btnMusCancel").style.display = "block";
    document.getElementById("formMusica").classList.add("edit-mode");
    document.getElementById("musTit").innerText = "Editando M√∫sica";
}

function salvarMusica() {
    const t = document.getElementById("musNome").value, v = Array.from(document.querySelectorAll('input[name="v_mus"]:checked')).map(cb => cb.value);
    if(!t) return alert("T√≠tulo obrigat√≥rio!");
    if(editIdxMus > -1) musicas[editIdxMus] = {titulo: t, vocalistas: v};
    else musicas.push({titulo: t, vocalistas: v});
    resetMusForm(); salvarNuvem();
}

function resetMusForm() { editIdxMus = -1; document.getElementById("musNome").value = ""; document.querySelectorAll('input[name="v_mus"]').forEach(cb => cb.checked = false); document.getElementById("btnMusCancel").style.display = "none"; document.getElementById("formMusica").classList.remove("edit-mode"); document.getElementById("musTit").innerText = "Nova M√∫sica"; }

function delMusica(i) { if(confirm("Excluir?")) { musicas.splice(i,1); salvarNuvem(); } }

// --- AUXILIARES E UI ---
function openTab(evt, name) {
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(name).classList.add('active');
    evt.currentTarget.classList.add('active');
}

function trocarMembro(el, func) {
    let baseFunc = func.split(" / ")[0];
    let p = integrantes.filter(it => it.funcoes.includes(baseFunc));
    let n = prompt("Trocar para:\n" + p.map(x => x.nome).join(", "));
    if(n) el.parentElement.querySelector("b").innerText = n;
}

function salvarEscalaGerada() {
    let h = document.getElementById("resultadoEscala").innerHTML;
    if(!h) return;
    historico.push({nome: "Escala " + new Date().toLocaleString(), html: h});
    salvarNuvem(); alert("Salvo no hist√≥rico!");
}

function renderHistorico() {
    const h = document.getElementById("listaHistorico"); h.innerHTML = "";
    historico.slice().reverse().forEach(esc => h.innerHTML += `<div class="card"><strong>${esc.nome}</strong><br>${esc.html}</div>`);
}

function limparHistorico() { if(confirm("Limpar tudo?")) { historico = []; salvarNuvem(); } }

function carregarLogo() {
    if(logoSalva) { document.getElementById("logoImg").src = logoSalva; document.getElementById("logoImg").style.display="block"; document.getElementById("logoEmoji").style.display="none"; }
}
function uploadLogo(e) {
    const f = e.target.files[0]; const r = new FileReader();
    r.onloadend = () => { logoSalva = r.result; localStorage.setItem("appLogo", logoSalva); carregarLogo(); };
    if(f) r.readAsDataURL(f);
}
function removerLogo() { logoSalva = null; localStorage.removeItem("appLogo"); location.reload(); }

function exportarParaExcel() {
    const rows = [["Data", "Fun√ß√£o", "Nome"]];
    document.querySelectorAll("#resultadoEscala .card").forEach(c => {
        const d = c.querySelector("h3").innerText;
        c.querySelectorAll(".escala-item span").forEach(i => rows.push([d, i.innerText.split(":")[0], i.querySelector("b").innerText]));
    });
    const ws = XLSX.utils.aoa_to_sheet(rows); const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Escala"); XLSX.writeFile(wb, "Escala_Louvor_2026.xlsx");
}

async function abrirMenuCompartilhar() {
    let t = "*ESCALA LOUVOR 2026*\n\n";
    document.querySelectorAll("#resultadoEscala .card").forEach(c => {
        t += `üìÖ *${c.querySelector("h3").innerText}*\n`;
        c.querySelectorAll(".escala-item span").forEach(i => t += `${i.innerText}\n`);
        t += "\n";
    });
    if(navigator.share) navigator.share({text: t}); else { navigator.clipboard.writeText(t); alert("Copiado para o clipboard!"); }
}

function fazerBackup() {
    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({integrantes, musicas, historico}));
    const downloadAnchorNode = document.createElement('a');
    downloadAnchorNode.setAttribute("href", dataStr);
    downloadAnchorNode.setAttribute("download", "backup_escala_2026.json");
    document.body.appendChild(downloadAnchorNode);
    downloadAnchorNode.click();
    downloadAnchorNode.remove();
}

carregarLogo();
</script>
</body>
</html>

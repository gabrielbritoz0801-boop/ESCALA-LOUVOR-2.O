<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>ESCALA LOUVOR 2026</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --bg: #f4f6fb; --card: #ffffff; --text: #1f2937; --primary: #2563eb; --danger: #dc2626; --success: #16a34a; --border: #cbd5e1; }
        body { margin: 0; font-family: sans-serif; background: var(--bg); color: var(--text); padding: 15px; }
        .card { background: var(--card); border-radius: 12px; padding: 15px; margin-bottom: 15px; border: 1px solid var(--border); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .row { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px; }
        input, select, button { padding: 10px; border-radius: 8px; border: 1px solid var(--border); }
        button { cursor: pointer; font-weight: bold; border: none; }
        .primary { background: var(--primary); color: white; }
        .success { background: var(--success); color: white; }
        .danger { background: var(--danger); color: white; }
        .tabs { display: flex; gap: 5px; margin-bottom: 15px; overflow-x: auto; }
        .tab-btn { flex: 1; padding: 10px; background: #e2e8f0; border-radius: 8px; white-space: nowrap; }
        .tab-btn.active { background: var(--primary); color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .escala-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #edf2f7; }
        .musica-tag { background: #e0e7ff; color: #4338ca; padding: 2px 8px; border-radius: 4px; font-size: 12px; margin-right: 5px; }
        .edit-mode { border: 2px solid var(--success) !important; background: #f0fff4 !important; }
        .sync-status { font-size: 12px; text-align: center; margin-bottom: 10px; font-weight: bold; }
    </style>
</head>
<body>

<div id="statusSync" class="sync-status">Conectando ao Firebase...</div>

<div class="tabs">
    <button class="tab-btn active" onclick="openTab(event, 'abaEscala')">üìÖ Escala</button>
    <button class="tab-btn" onclick="openTab(event, 'abaMusicas')">üéµ M√∫sicas</button>
    <button class="tab-btn" onclick="openTab(event, 'abaEquipe')">üë• Equipe</button>
</div>

<div id="abaEscala" class="tab-content active">
    <div class="card">
        <div class="row">
            <select id="mesSelecao">
                <option value="0">Janeiro</option><option value="1">Fevereiro</option><option value="2">Mar√ßo</option>
                <option value="3">Abril</option><option value="4">Maio</option><option value="5">Junho</option>
                <option value="6">Julho</option><option value="7">Agosto</option><option value="8">Setembro</option>
                <option value="9">Outubro</option><option value="10">Novembro</option><option value="11">Dezembro</option>
            </select>
            <button class="primary" onclick="gerarEscala()">Gerar</button>
            <button class="success" onclick="salvarNoHistorico()">Salvar</button>
        </div>
    </div>
    <div id="resultadoEscala"></div>
</div>

<div id="abaMusicas" class="tab-content">
    <div class="card" id="formMusica">
        <h3 id="musTit">Nova M√∫sica</h3>
        <input id="musNome" placeholder="T√≠tulo da m√∫sica" style="width:90%">
        <div id="vocaisCheck" class="row" style="margin-top:10px"></div>
        <button class="success" onclick="salvarMusica()">Salvar M√∫sica</button>
        <button id="btnCancelMus" style="display:none" onclick="resetMusForm()">Cancelar</button>
    </div>
    <div id="listaMusicas"></div>
</div>

<div id="abaEquipe" class="tab-content">
    <div class="card" id="formInt">
        <h3 id="eqpTit">Novo Integrante</h3>
        <input id="intNome" placeholder="Nome" style="width:90%">
        <div id="funcoesCheck" class="row" style="margin-top:10px"></div>
        <button class="success" onclick="salvarInt()">Salvar Integrante</button>
        <button id="btnCancelInt" style="display:none" onclick="resetIntForm()">Cancelar</button>
    </div>
    <div id="listaIntegrantes"></div>
</div>

<script>
// --- CONFIGURA√á√ÉO (Verifique se estas credenciais est√£o corretas no console.firebase.google.com) ---
const firebaseConfig = {
    apiKey: "AIzaSyCoFW2dGfZTmKE4LNRL0TJBNACUneRmUJQ",
    authDomain: "escala-louvor-f5c43.firebaseapp.com",
    projectId: "escala-louvor-f5c43",
    databaseURL: "https://escala-louvor-f5c43-default-rtdb.firebaseio.com/", // Verifique se o URL est√° correto
    storageBucket: "escala-louvor-f5c43.appspot.com",
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let integrantes = [], musicas = [], historico = [];
let editIdxMus = -1, editIdxInt = -1;
const funcoesLista = ["Ministro", "Vocal 1", "Vocal 2", "Vocal 3", "Violonista", "Guitarrista", "Baixista", "Baterista", "Tecladista", "Mesa de Som", "M√≠dia"];

// --- SINCRONIZA√á√ÉO EM TEMPO REAL ---
db.ref('escala_v1').on('value', (snapshot) => {
    const data = snapshot.val() || {};
    integrantes = data.integrantes || [];
    musicas = data.musicas || [];
    historico = data.historico || [];
    
    document.getElementById('statusSync').innerText = "‚úì Sincronizado";
    renderEquipe();
    renderMusicas();
});

function salvarNuvem() {
    document.getElementById('statusSync').innerText = "Salvando...";
    db.ref('escala_v1').set({
        integrantes: integrantes,
        musicas: musicas,
        historico: historico
    }).then(() => {
        document.getElementById('statusSync').innerText = "‚úì Salvo";
    });
}

// --- L√ìGICA DE GERA√á√ÉO (RESPEITANDO SUAS REGRAS) ---
function gerarEscala() {
    const mes = parseInt(document.getElementById("mesSelecao").value);
    const container = document.getElementById("resultadoEscala");
    container.innerHTML = "";
    
    const diasNoMes = new Date(2026, mes + 1, 0).getDate();
    
    for (let d = 1; d <= diasNoMes; d++) {
        const data = new Date(2026, mes, d);
        if (![0, 3].includes(data.getDay())) continue;

        let escaladosDia = [];
        let micsUso = 0;
        let vocaisDia = [];
        let htmlCorpo = "";

        // 1. Ministro (Regra: Mesclar se for vocal e contar mic)
        let mins = integrantes.filter(it => it.funcoes.includes("Ministro")).sort(() => Math.random() - 0.5);
        let m = mins[0];
        if (m) {
            escaladosDia.push(m.nome);
            let isVocal = m.funcoes.some(f => f.toLowerCase().includes("vocal"));
            let label = isVocal ? "Ministro / Vocal" : "Ministro";
            if(isVocal) { micsUso++; vocaisDia.push(m.nome); }
            htmlCorpo += `<div class="escala-item"><span>${label}: <b>${m.nome}</b></span></div>`;
        }

        // 2. Outras Fun√ß√µes (Limite 4 microfones)
        funcoesLista.forEach(f => {
            if (f === "Ministro") return;
            const ehVocal = f.toLowerCase().includes("vocal");
            if (ehVocal && micsUso >= 4) return;

            let cand = integrantes.filter(it => it.funcoes.includes(f) && !escaladosDia.includes(it.nome))
                                  .sort(() => Math.random() - 0.5);
            let s = cand[0];
            if (s) {
                escaladosDia.push(s.nome);
                if(ehVocal) { micsUso++; vocaisDia.push(s.nome); }
                htmlCorpo += `<div class="escala-item"><span>${f}: <b>${s.nome}</b></span></div>`;
            }
        });

        container.innerHTML += `<div class="card"><h3>${data.toLocaleDateString('pt-BR', {weekday:'long', day:'2-digit', month:'2-digit'})}</h3>${htmlCorpo}</div>`;
    }
}

// --- GERENCIAMENTO DE EQUIPE ---
function renderEquipe() {
    const lista = document.getElementById("listaIntegrantes");
    lista.innerHTML = "";
    document.getElementById("funcoesCheck").innerHTML = funcoesLista.map(f => `<label><input type="checkbox" name="f_int" value="${f}"> ${f}</label>`).join("");
    
    integrantes.forEach((it, i) => {
        lista.innerHTML += `<div class="escala-item">
            <span><b>${it.nome}</b> (${it.funcoes.join(", ")})</span>
            <div>
                <button class="primary" onclick="editInt(${i})">‚úèÔ∏è</button>
                <button class="danger" onclick="delInt(${i})">üóë</button>
            </div>
        </div>`;
    });
}

function salvarInt() {
    const nome = document.getElementById("intNome").value;
    const funcs = Array.from(document.querySelectorAll('input[name="f_int"]:checked')).map(c => c.value);
    if(!nome) return;

    if(editIdxInt > -1) integrantes[editIdxInt] = {nome, funcoes: funcs};
    else integrantes.push({nome, funcoes: funcs});
    
    resetIntForm();
    salvarNuvem();
}

function editInt(i) {
    editIdxInt = i;
    const it = integrantes[i];
    document.getElementById("intNome").value = it.nome;
    document.querySelectorAll('input[name="f_int"]').forEach(cb => cb.checked = it.funcoes.includes(cb.value));
    document.getElementById("formInt").classList.add("edit-mode");
    document.getElementById("btnCancelInt").style.display = "inline";
}

function resetIntForm() {
    editIdxInt = -1;
    document.getElementById("intNome").value = "";
    document.querySelectorAll('input[name="f_int"]').forEach(cb => cb.checked = false);
    document.getElementById("formInt").classList.remove("edit-mode");
    document.getElementById("btnCancelInt").style.display = "none";
}

// --- GERENCIAMENTO DE M√öSICAS ---
function renderMusicas() {
    const lista = document.getElementById("listaMusicas");
    lista.innerHTML = "";
    // Filtra quem pode ser vocalista para o check de m√∫sicas
    const vocaisDisp = integrantes.filter(it => it.funcoes.some(f => f.includes("Vocal") || f === "Ministro"));
    document.getElementById("vocaisCheck").innerHTML = vocaisDisp.map(v => `<label><input type="checkbox" name="v_mus" value="${v.nome}"> ${v.nome}</label>`).join("");

    musicas.forEach((m, i) => {
        lista.innerHTML += `<div class="escala-item">
            <span><b>${m.titulo}</b></span>
            <div>
                <button class="primary" onclick="editMusica(${i})">‚úèÔ∏è</button>
                <button class="danger" onclick="delMusica(${i})">üóë</button>
            </div>
        </div>`;
    });
}

function salvarMusica() {
    const titulo = document.getElementById("musNome").value;
    const vocs = Array.from(document.querySelectorAll('input[name="v_mus"]:checked')).map(c => c.value);
    if(!titulo) return;

    if(editIdxMus > -1) musicas[editIdxMus] = {titulo, vocalistas: vocs};
    else musicas.push({titulo, vocalistas: vocs});
    
    resetMusForm();
    salvarNuvem();
}

function editMusica(i) {
    editIdxMus = i;
    document.getElementById("musNome").value = musicas[i].titulo;
    document.querySelectorAll('input[name="v_mus"]').forEach(cb => cb.checked = musicas[i].vocalistas.includes(cb.value));
    document.getElementById("formMusica").classList.add("edit-mode");
    document.getElementById("btnCancelMus").style.display = "inline";
}

function resetMusForm() {
    editIdxMus = -1;
    document.getElementById("musNome").value = "";
    document.querySelectorAll('input[name="v_mus"]').forEach(cb => cb.checked = false);
    document.getElementById("formMusica").classList.remove("edit-mode");
    document.getElementById("btnCancelMus").style.display = "none";
}

function delInt(i) { if(confirm("Excluir?")) { integrantes.splice(i,1); salvarNuvem(); } }
function delMusica(i) { if(confirm("Excluir?")) { musicas.splice(i,1); salvarNuvem(); } }

function openTab(evt, name) {
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(name).classList.add('active');
    evt.currentTarget.classList.add('active');
}
</script>
</body>
</html>
